<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Category: Hook - xiejunyi Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="xiejunyi"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="xiejunyi"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="xiejunyi Blog"><meta property="og:url" content="http://yoursite.com/"><meta property="og:site_name" content="xiejunyi Blog"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://yoursite.com/img/og_image.png"><meta property="article:author" content="junyixie"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com"},"headline":"xiejunyi Blog","image":["http://yoursite.com/img/og_image.png"],"author":{"@type":"Person","name":"junyixie"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">xiejunyi&#039;s Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li class="is-active"><a href="#" aria-current="page">Hook</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2018-01-14T16:35:39.000Z" title="2018-01-14T16:35:39.000Z">2018-01-15</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-11-26T15:33:29.000Z" title="2019-11-26T15:33:29.000Z">2019-11-26</time></span><span class="level-item"><a class="link-muted" href="/categories/Hook/">Hook</a></span><span class="level-item">5 minutes read (About 686 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2018/01/15/sharedlibraryandpic/">fishhook与共享库和PIC</a></h1><div class="content"><p>fishhook是不能hook同一个library内的符号调用的，在某个issus的解答如下。</p>
<blockquote>
<p>People have had issues with socket and/or connect in the past. One problem is that fishhook can only hook external calls, which means function calls within the same library generally cannot be hooked. In this case, calls to socket and connect from within the same library (libSystem) cannot be hooked. With the simulator, the system libraries are broken out into many sub-libraries, including libsystem_networking. With many sub-libraries, this means function calls from one sub-library to another can be hooked on the simulator, but on device where there’s just a single libSystem, those same calls are within the same library and cannot be hooked.</p>
</blockquote>
<p>这是由于fishhook利用 Macho-O dyld link 的 dynamically rebinding symbols实现所导致的。</p>
<p>这边文章就围绕这个话题来展开，解释一下la_symbol_ptr存在的原因。由于Mac OS 上使用 stubs, la_symbol_ptrs, stub_helper来实现延迟绑定的原理和Linux ELF差不多，这里就使用ELF的实现来解释。</p>
<h2 id="PIC位置无关代码的引入"><a href="#PIC位置无关代码的引入" class="headerlink" title="PIC位置无关代码的引入"></a>PIC位置无关代码的引入</h2><p>设想一个场景，因为Linux/Mac os使用的是虚拟内存系统，这意味着共享库引用的外部符号地址在不同进程的虚拟内存中是不同的，对应到物理内存中TEXT段也不同，所以必须拷贝多份。这显然是不可以接受的，内存中存在了大量拷贝，浪费RAM资源。</p>
<p>如果我们共享库对外部引用是位置无关的就好了，就不会存在这个问题。</p>
<h3 id="GOT-全局偏移表"><a href="#GOT-全局偏移表" class="headerlink" title="GOT 全局偏移表"></a>GOT 全局偏移表</h3><p>这时利用DATA段读写的特性，DATA段会在内存中有多份拷贝，并且DATA段和TEXT段的距离不变，在DATA段存储变化的地址，TEXT段使用指向DATA段对应位置的引用。这就解决了TEXT段共享的问题。这里我们引入了一个全局偏移量表，GOT。动态链接器会重定位GOT中的每个条目，使得它包含正确的绝对地址。</p>
<h3 id="PIC函数调用-和-PLT过程链接表"><a href="#PIC函数调用-和-PLT过程链接表" class="headerlink" title="PIC函数调用 和 PLT过程链接表"></a>PIC函数调用 和 PLT过程链接表</h3><p>使用GOT这种方式，我们每次调用函数都需要额外的三条指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        call L1</span><br><span class="line">L1:   popl %ebx </span><br><span class="line">        addl $PROCOFF, %ebx</span><br><span class="line">        call *(%ebx)</span><br></pre></td></tr></table></figure>
<ol>
<li>将PC的值移到 ebx中</li>
<li>ebx 指向GOT中适当的条目</li>
</ol>
<p>这样的效率未免有些低。于是引入了 延迟绑定的技术，将过程地址的绑定推迟到第一次调用该过程时。第一次调用过程的运行时开销很大，但是其后的每次调用都只会花费一条指令和一个间接地存储器引用。</p>
<p><strong>过程</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call 8048464</span><br></pre></td></tr></table></figure>
<p>调用相应的PLT条目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jmp *0x8049684</span><br><span class="line">pushl $0x8</span><br><span class="line">jmp 8048444</span><br></pre></td></tr></table></figure>
<p>跳转到addvec</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2017-12-04T06:08:16.000Z" title="2017-12-04T06:08:16.000Z">2017-12-04</time></span><span class="level-item">Updated&nbsp;<time dateTime="2019-11-26T15:32:43.000Z" title="2019-11-26T15:32:43.000Z">2019-11-26</time></span><span class="level-item"><a class="link-muted" href="/categories/Hook/">Hook</a></span><span class="level-item">12 minutes read (About 1856 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2017/12/04/safeSwizzleRSSwizzleAnalyze/">Method Swizzling 的正确途径</a></h1><div class="content"><p>iOS 平台开发，有时会使用到Method Swizzling,  但Method Swizzling 在使用过程中有许多需要注意的问题，本文将介绍将会产生的问题，并且分析 <a target="_blank" rel="noopener" href="https://github.com/rabovik/RSSwizzle">RSSwizzle</a> 是如何解决这些问题的。</p>
<h2 id="在Objective-C-中方法交换有什么危险"><a href="#在Objective-C-中方法交换有什么危险" class="headerlink" title="在Objective-C 中方法交换有什么危险"></a>在Objective-C 中方法交换有什么危险</h2><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c?answertab=active#tab-top">What are the Dangers of Method Swizzling in Objective C?</a><br>stackoverflow 上的这个回答十分精彩。</p>
<pre><code>- Method swizzling 并不是原子操作
- 改变了不是我们自己代码的行为
- 有可能出现命名冲突
- Swizzling 改变方法的参数
- Swizzles 顺序问题
- 难于理解
- 难于Debug</code></pre><h3 id="Swizzling-改变方法的参数-例子"><a href="#Swizzling-改变方法的参数-例子" class="headerlink" title="Swizzling 改变方法的参数 例子"></a>Swizzling 改变方法的参数 例子</h3><p>使用<code>method_exchangeImplementations</code>更改方法的实现，会导致一个问题，origin_imp 如果使用了 _cmd 参数，hook之后的_cmd 是不符合预期的。</p>
<p>hook <code>touchesBegan</code> 过的同学应该遇到这种问题。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;</span><br></pre></td></tr></table></figure>

<p>这个函数里面 调用了 <code>forwardTouchMethod</code> , 反汇编后类似这种。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    forwardTouchMethod(<span class="keyword">self</span>, _cmd, touches, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> forwardTouchMethod(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, <span class="built_in">NSSet</span> *touches, <span class="built_in">UIEvent</span> *event) &#123;</span><br><span class="line">  <span class="comment">// The responder chain is used to figure out where to send the next touch</span></span><br><span class="line">    <span class="built_in">UIResponder</span> *nextResponder = [<span class="keyword">self</span> nextResponder];</span><br><span class="line">    <span class="keyword">if</span> (nextResponder &amp;&amp; nextResponder != <span class="keyword">self</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Not all touches are forwarded - so we filter here.</span></span><br><span class="line">        <span class="built_in">NSMutableSet</span> *filteredTouches = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">        [touches enumerateObjectsUsingBlock:^(<span class="built_in">UITouch</span> *touch, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Checks every touch for forwarding requirements.</span></span><br><span class="line">            <span class="keyword">if</span> ([touch _wantsForwardingFromResponder:<span class="keyword">self</span> toNextResponder:nextResponder withEvent:event]) &#123;</span><br><span class="line">                [filteredTouches addObject:touch];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// This is interesting legacy behavior. Before iOS 5, all touches are forwarded (and this is logged)</span></span><br><span class="line">                <span class="keyword">if</span> (!_UIApplicationLinkedOnOrAfter(<span class="number">12</span>)) &#123;</span><br><span class="line">                    [filteredTouches addObject:touch];</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Log old behavior</span></span><br><span class="line">                    <span class="keyword">static</span> <span class="built_in">BOOL</span> didLog = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!didLog) &#123;</span><br><span class="line">                        <span class="built_in">NSLog</span>(<span class="string">@&quot;Pre-iOS 5.0 touch delivery method forwarding relied upon. Forwarding -%@ to %@.&quot;</span>, <span class="built_in">NSStringFromSelector</span>(_cmd), nextResponder);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// here we basically call [nextResponder touchesBegan:filteredTouches event:event];</span></span><br><span class="line">        [nextResponder performSelector:_cmd withObject:filteredTouches withObject:event];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们exchange了 imp, <code>[nextResponder performSelector:_cmd withObject:filteredTouches withObject:event];</code> 是没有相应的实现的，<strong>_cmd</strong> 就变成了 我们替换的 sel. 显然，nextResponder没有实现相应的方法，就会crash。</p>
<h4 id="正确的hook方式"><a href="#正确的hook方式" class="headerlink" title="正确的hook方式"></a><strong>正确的hook方式</strong></h4><p><strong>方案一:</strong><br>直接替换 method 的 IMP.<br><code>method_setImplementation</code>, 在新的IMP中调用原始的 IMP.</p>
<h2 id="RSSwizzle"><a href="#RSSwizzle" class="headerlink" title="RSSwizzle"></a>RSSwizzle</h2><p><strong>RSSwizzle 实现方式</strong><br>    1. 根据block生成NEW IMP<br>    2. replace 目标方法的实现<br>    3. block可以获取原来的IMP</p>
<p><strong>核心交换代码</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> swizzle(Class classToSwizzle,</span><br><span class="line">                    SEL selector,</span><br><span class="line">                    RSSwizzleImpFactoryBlock factoryBlock)</span><br><span class="line">&#123;</span><br><span class="line">    Method method = class_getInstanceMethod(classToSwizzle, selector);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSCAssert</span>(<span class="literal">NULL</span> != method,</span><br><span class="line">              <span class="string">@&quot;Selector %@ not found in %@ methods of class %@.&quot;</span>,</span><br><span class="line">              <span class="built_in">NSStringFromSelector</span>(selector),</span><br><span class="line">              class_isMetaClass(classToSwizzle) ? <span class="string">@&quot;class&quot;</span> : <span class="string">@&quot;instance&quot;</span>,</span><br><span class="line">              classToSwizzle);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSCAssert</span>(blockIsAnImpFactoryBlock(factoryBlock),</span><br><span class="line">             <span class="string">@&quot;Wrong type of implementation factory block.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    __block OSSpinLock lock = OS_SPINLOCK_INIT;</span><br><span class="line">    <span class="comment">// To keep things thread-safe, we fill in the originalIMP later,</span></span><br><span class="line">    <span class="comment">// with the result of the class_replaceMethod call below.</span></span><br><span class="line">    __block IMP originalIMP = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This block will be called by the client to get original implementation and call it.</span></span><br><span class="line">    RSSWizzleImpProvider originalImpProvider = ^IMP&#123;</span><br><span class="line">        <span class="comment">// It&#x27;s possible that another thread can call the method between the call to</span></span><br><span class="line">        <span class="comment">// class_replaceMethod and its return value being set.</span></span><br><span class="line">        <span class="comment">// So to be sure originalIMP has the right value, we need a lock.</span></span><br><span class="line">        OSSpinLockLock(&amp;lock);</span><br><span class="line">        IMP imp = originalIMP;</span><br><span class="line">        OSSpinLockUnlock(&amp;lock);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == imp)&#123;</span><br><span class="line">            <span class="comment">// If the class does not implement the method</span></span><br><span class="line">            <span class="comment">// we need to find an implementation in one of the superclasses.</span></span><br><span class="line">            Class superclass = class_getSuperclass(classToSwizzle);</span><br><span class="line">            imp = method_getImplementation(class_getInstanceMethod(superclass,selector));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> imp;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    RSSwizzleInfo *swizzleInfo = [RSSwizzleInfo new];</span><br><span class="line">    swizzleInfo.selector = selector;</span><br><span class="line">    swizzleInfo.impProviderBlock = originalImpProvider;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// We ask the client for the new implementation block.</span></span><br><span class="line">    <span class="comment">// We pass swizzleInfo as an argument to factory block, so the client can</span></span><br><span class="line">    <span class="comment">// call original implementation from the new implementation.</span></span><br><span class="line">    <span class="keyword">id</span> newIMPBlock = factoryBlock(swizzleInfo);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *methodType = method_getTypeEncoding(method);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSCAssert</span>(blockIsCompatibleWithMethodType(newIMPBlock,methodType),</span><br><span class="line">             <span class="string">@&quot;Block returned from factory is not compatible with method type.&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    IMP newIMP = imp_implementationWithBlock(newIMPBlock);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Atomically replace the original method with our new implementation.</span></span><br><span class="line">    <span class="comment">// This will ensure that if someone else&#x27;s code on another thread is messing</span></span><br><span class="line">    <span class="comment">// with the class&#x27; method list too, we always have a valid method at all times.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the class does not implement the method itself then</span></span><br><span class="line">    <span class="comment">// class_replaceMethod returns NULL and superclasses&#x27;s implementation will be used.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We need a lock to be sure that originalIMP has the right value in the</span></span><br><span class="line">    <span class="comment">// originalImpProvider block above.</span></span><br><span class="line">    OSSpinLockLock(&amp;lock);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// originIMP get value from here</span></span><br><span class="line">    originalIMP = class_replaceMethod(classToSwizzle, selector, newIMP, methodType);</span><br><span class="line">    OSSpinLockUnlock(&amp;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体过程解析</strong></p>
<p><strong>如果hook的方法在hook的类中有实现</strong><br>    1. block生成新的IMP<br>    2. 替换IMP, 这时候拿到原始的ORIGINIMP<br>    3. block接受了一个RSSwizzleInfo参数，从参数中可以拿到当时保存的获得IMP的block<br>    4. 由于block中存储的是originIMP ，所以获得的是原始的实现</p>
<p><strong>如果hook的方法在子类中无实现</strong><br>    1. block生成新的IMP<br>    2. 替换IMP（由于没有实现，相当于add了IMP）, 原始的实现为nil<br>    3. block 中我们调用calloriginIMP,这个方法实际调用了一个block originalImpProvider<br>    4. 这个block的从父类找到相应的实现（注意，这里实际上是在 调用方法 时才会触发）</p>
<p>这种情况是调用时，动态获得 当时的方法实现，所以可以避免hook顺序带来的问题。</p>
<h3 id="那么影响Swizzle的结果到底是是什么呢？"><a href="#那么影响Swizzle的结果到底是是什么呢？" class="headerlink" title="那么影响Swizzle的结果到底是是什么呢？"></a>那么影响Swizzle的结果到底是是什么呢？</h3><p>Swizzle实现方式本质上就是改变方法的IMP 为 NewIMP, 并调用原先的originIMP</p>
<p>只hook一个是没问题，但是涉及到多次hook, 并且hook的方法可能为一个时， 他们的顺序就会导致不同的结果，因为顺序不同，Swizzle时，Method 相应的 IMP 不相同。<br>这里我们更关注，父子类+hook 同一个方法产生的问题。</p>
<p><strong>那么RSSwizzle  怎么解决问题的呢？</strong></p>
<p>父类有method, 子类没有实现method.<br>我们有如下的IMP:<code>superIMP</code>,<code>superNewIMP</code>,<code>subNewIMp</code><br>此时，我们Swizzle 父类的method 为 superNewIMP<br>Swizzle子类的method 为 subNewIMp</p>
<p><strong>首先关注我们期望的调用顺序</strong><br>    1. subNewIMP<br>    2. superNewIMP<br>    3. superIMP</p>
<p><strong>我们先hook父类，再hook子类后，的调用顺序</strong><br>    1. subNewImp<br>    2. superNewIMP<br>    3. superIMp</p>
<p><strong>先hook子类再hook父类</strong><br>    1. subNewIMP<br>    2. superIMP</p>
<p><strong>为什么会有差异?</strong><br>因为当我们在hook子类方法时，原先的方法实现是不同的。</p>
<p><strong>解决问题</strong><br>那就要保证，即使hook的顺序不同，也能正确取到相应的IMP<br>那我们保证，子类在调用相应方法的时候，取到的IMP是父类当前的IMP就可以(这样就和Swizzle的时间顺序没有了关系)</p>
<h2 id="RSSwizzle-加锁，保证线程安全"><a href="#RSSwizzle-加锁，保证线程安全" class="headerlink" title="RSSwizzle 加锁，保证线程安全"></a>RSSwizzle 加锁，保证线程安全</h2><p><strong><code>originalImpProvider</code> 的代码</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RSSWizzleImpProvider originalImpProvider = ^IMP&#123;</span><br><span class="line">    OSSpinLockLock(&amp;lock);</span><br><span class="line">    IMP imp = originalIMP;</span><br><span class="line">    OSSpinLockUnlock(&amp;lock);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == imp)&#123;</span><br><span class="line">        Class superclass = class_getSuperclass(classToSwizzle);</span><br><span class="line">        imp = method_getImplementation(class_getInstanceMethod(superclass,selector));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Swizzle 方法的某个部分</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OSSpinLockLock(&amp;lock);</span><br><span class="line">originalIMP = class_replaceMethod(classToSwizzle, selector, newIMP, methodType);</span><br><span class="line">OSSpinLockUnlock(&amp;lock);</span><br></pre></td></tr></table></figure>

<p>这两个方法有个共享变量 originalIMP，这就意味着，可能会出现线程安全问题。再仔细看下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OSSpinLockLock(&amp;lock);</span><br><span class="line">IMP imp &#x3D; originalIMP;</span><br><span class="line">OSSpinLockUnlock(&amp;lock);</span><br><span class="line">if (NULL &#x3D;&#x3D; imp)&#123;</span><br></pre></td></tr></table></figure>
<p>这个共享变量，和条件判断相关。敏锐的同学一眼就能看出来，在不加锁的情况下，当不同的线程对 这两段代码进行执行的时候，就会出现，即使<code>if (NULL == imp)&#123;</code>通过了，但实际上，另一条线程执行了<code>class_replaceMethod()</code>。这时就会出现问题。</p>
<p>在加锁之后，在同一时间段内，只有一个线程能访问改变这个变量的代码。避免了共享变量导致的线程安全问题。</p>
<h2 id="采用Block添加实现，没有命名冲突问题"><a href="#采用Block添加实现，没有命名冲突问题" class="headerlink" title="采用Block添加实现，没有命名冲突问题"></a>采用Block添加实现，没有命名冲突问题</h2><p>连命名的机会都没有…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RSSwizzleInstanceMethod(classToSwizzle,</span><br><span class="line">                        @selector(calculate:),</span><br><span class="line">                        RSSWReturnType(int),</span><br><span class="line">                        RSSWArguments(int number),</span><br><span class="line">                        RSSWReplacement(</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; The following code will be used as the new implementation.</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Calling original implementation.</span><br><span class="line">    int res &#x3D; RSSWCallOriginal(number);</span><br><span class="line">    &#x2F;&#x2F; Returning modified return value.</span><br><span class="line">    return res + 1;</span><br><span class="line">&#125;), 0, NULL);</span><br></pre></td></tr></table></figure>

<h2 id="采用block-添加实现，只是改变了原来的IMP-，Selector没有改变，实现的-cmd并没有改变"><a href="#采用block-添加实现，只是改变了原来的IMP-，Selector没有改变，实现的-cmd并没有改变" class="headerlink" title="采用block 添加实现，只是改变了原来的IMP ，Selector没有改变，实现的_cmd并没有改变"></a>采用block 添加实现，只是改变了原来的IMP ，Selector没有改变，实现的<code>_cmd</code>并没有改变</h2><p>参数<code>_cmd</code>是当前方法的selector</p>
<p>swizzle method 可能会导致的<code>_cmd</code> 参数改变，例如<br>我们有<code>originMethod</code>和<code>newMethod</code>,他们分别对应着 <code>OriginIMP</code>,和<code>NewIMP</code>.<br>当我们交换方法实现后:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">originmethod -&gt; NewIMP</span><br><span class="line">newMethod -&gt; OriginIMP</span><br></pre></td></tr></table></figure>
<p>要想调用原来的实现，我们需要调用 <code>newMethod</code> 这就导致了 相同的IMP 但是<code>_cmd</code> 却改变了 </p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="xiejunyi"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">xiejunyi</p><p class="is-size-6 is-block">底层码农</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">34</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/junyixie" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/junyixie"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://maimai.cn/contact/detail/179426899" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">脉脉</span></span><span class="level-right"><span class="level-item tag">maimai.cn</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/APM/"><span class="level-start"><span class="level-item">APM</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/Hook/"><span class="level-start"><span class="level-item">Hook</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/cpython%E4%BC%98%E5%8C%96/"><span class="level-start"><span class="level-item">cpython优化</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/iOS/"><span class="level-start"><span class="level-item">iOS</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span class="level-start"><span class="level-item">源码分析</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E7%A0%94%E5%8F%91%E6%B5%81%E7%A8%8B/"><span class="level-start"><span class="level-item">研发流程</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84/"><span class="level-start"><span class="level-item">设计架构</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-01T08:04:26.000Z">2021-04-01</time></p><p class="title"><a href="/2021/04/01/cpython-sub-interpreter-parallel/">cpython 子解释器并行实现</a></p><p class="categories"><a href="/categories/cpython%E4%BC%98%E5%8C%96/">cpython优化</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-23T14:50:13.000Z">2021-03-23</time></p><p class="title"><a href="/2021/03/23/cpython-project-software-engineering/">cpython项目软件工程</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-02-19T12:45:55.000Z">2021-02-19</time></p><p class="title"><a href="/2021/02/19/behind-thread-local/">behind __thread. __thread实现原理</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-01-25T12:52:56.000Z">2021-01-25</time></p><p class="title"><a href="/2021/01/25/cpython-mutilcore/">cpython mutilcore 实现</a></p><p class="categories"><a href="/categories/cpython%E4%BC%98%E5%8C%96/">cpython优化</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-10T13:57:17.000Z">2020-12-10</time></p><p class="title"><a href="/2020/12/10/clang-add-option/">clang添加命令行参数</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">February 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">January 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">November 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">October 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/09/"><span class="level-start"><span class="level-item">September 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/12/"><span class="level-start"><span class="level-item">December 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/05/"><span class="level-start"><span class="level-item">May 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/04/"><span class="level-start"><span class="level-item">April 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/02/"><span class="level-start"><span class="level-item">February 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/01/"><span class="level-start"><span class="level-item">January 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">xiejunyi&#039;s Blog</a><p class="is-size-7"><span>&copy; 2021 junyixie</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>