<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>iOS Hook æ–¹æ¡ˆè§£æ | xiejunyi Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="æœ€è¿‘ç ”ç©¶äº†ä¸€ä¸‹iOSå¹³å°ä¸Šå‡ ä¸ªhookæ¡†æ¶çš„hookæ–¹æ¡ˆï¼Œå†™æ–‡è®°å½•ä¸€ä¸‹åˆ†æçš„è¿‡ç¨‹ ç°æœ‰hookæ¡†æ¶ AnyMethodLog Aspects  AnyMethodLog hook æ–¹æ¡ˆåˆ†æHook ä»£ç   123456789101112131415161718192021222324252627282930313233343536373839404142&#x2F;&#x2F;æ›¿æ¢æ–¹æ³•BOOL qhd_replace">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS Hook æ–¹æ¡ˆè§£æ">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2017&#x2F;11&#x2F;30&#x2F;ioshookanalysis&#x2F;index.html">
<meta property="og:site_name" content="xiejunyi Blog">
<meta property="og:description" content="æœ€è¿‘ç ”ç©¶äº†ä¸€ä¸‹iOSå¹³å°ä¸Šå‡ ä¸ªhookæ¡†æ¶çš„hookæ–¹æ¡ˆï¼Œå†™æ–‡è®°å½•ä¸€ä¸‹åˆ†æçš„è¿‡ç¨‹ ç°æœ‰hookæ¡†æ¶ AnyMethodLog Aspects  AnyMethodLog hook æ–¹æ¡ˆåˆ†æHook ä»£ç   123456789101112131415161718192021222324252627282930313233343536373839404142&#x2F;&#x2F;æ›¿æ¢æ–¹æ³•BOOL qhd_replace">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2017&#x2F;11&#x2F;30&#x2F;ioshookanalysis&#x2F;callStack.png">
<meta property="og:updated_time" content="2019-11-26T15:35:32.961Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2017&#x2F;11&#x2F;30&#x2F;ioshookanalysis&#x2F;callStack.png">
  
    <link rel="alternate" href="/atom.xml" title="xiejunyi Blog" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">xiejunyi Blog</h1>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          <article id="post-ioshookanalysis" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 class="article-title" itemprop="name">
      iOS Hook æ–¹æ¡ˆè§£æ
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/11/30/ioshookanalysis/" class="article-date"><time datetime="2017-11-30T03:37:13.000Z" itemprop="datePublished">2017-11-30</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Hook/">Hook</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>æœ€è¿‘ç ”ç©¶äº†ä¸€ä¸‹iOSå¹³å°ä¸Šå‡ ä¸ªhookæ¡†æ¶çš„hookæ–¹æ¡ˆï¼Œå†™æ–‡è®°å½•ä¸€ä¸‹åˆ†æçš„è¿‡ç¨‹</strong></p>
<h2 id="ç°æœ‰hookæ¡†æ¶"><a href="#ç°æœ‰hookæ¡†æ¶" class="headerlink" title="ç°æœ‰hookæ¡†æ¶"></a>ç°æœ‰hookæ¡†æ¶</h2><ol>
<li>AnyMethodLog</li>
<li>Aspects</li>
</ol>
<h2 id="AnyMethodLog-hook-æ–¹æ¡ˆåˆ†æ"><a href="#AnyMethodLog-hook-æ–¹æ¡ˆåˆ†æ" class="headerlink" title="AnyMethodLog hook æ–¹æ¡ˆåˆ†æ"></a>AnyMethodLog hook æ–¹æ¡ˆåˆ†æ</h2><p>Hook ä»£ç  </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ›¿æ¢æ–¹æ³•</span></span><br><span class="line"><span class="built_in">BOOL</span> qhd_replaceMethod(Class cls, SEL originSelector, <span class="keyword">char</span> *returnType) &#123;</span><br><span class="line">    Method originMethod = class_getInstanceMethod(cls, originSelector);</span><br><span class="line">    <span class="keyword">if</span> (originMethod == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *originTypes = method_getTypeEncoding(originMethod);</span><br><span class="line">    IMP msgForwardIMP = _objc_msgForward;</span><br><span class="line"><span class="meta">#if !defined(__arm64__)</span></span><br><span class="line">    <span class="keyword">if</span> (qhd_isStructType(returnType)) &#123;</span><br><span class="line">        <span class="comment">//Reference JSPatch:</span></span><br><span class="line">        <span class="comment">//In some cases that returns struct, we should use the '_stret' API:</span></span><br><span class="line">        <span class="comment">//http://sealiesoftware.com/blog/archive/2008/10/30/objc_explain_objc_msgSend_stret.html</span></span><br><span class="line">        <span class="comment">//NSMethodSignature knows the detail but has no API to return, we can only get the info from debugDescription.</span></span><br><span class="line">        <span class="built_in">NSMethodSignature</span> *methodSignature = [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:originTypes];</span><br><span class="line">        <span class="keyword">if</span> ([methodSignature.debugDescription rangeOfString:<span class="string">@"is special struct return? YES"</span>].location != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">            msgForwardIMP = (IMP)_objc_msgForward_stret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    IMP originIMP = method_getImplementation(originMethod);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (originIMP == <span class="literal">nil</span> || originIMP == msgForwardIMP) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æŠŠåŸæ–¹æ³•çš„IMPæ¢æˆ_objc_msgForwardï¼Œä½¿ä¹‹è§¦å‘forwardInvocationæ–¹æ³•</span></span><br><span class="line">    class_replaceMethod(cls, originSelector, msgForwardIMP, originTypes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æŠŠæ–¹æ³•forwardInvocationçš„IMPæ¢æˆqhd_forwardInvocation</span></span><br><span class="line">    class_replaceMethod(cls, <span class="keyword">@selector</span>(forwardInvocation:), (IMP)qhd_forwardInvocation, <span class="string">"v@:@"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°æ–¹æ³•ï¼ŒIMPå°±æ˜¯åŸæ–¹æ³•çš„åŸæ¥çš„IMPï¼Œé‚£ä¹ˆåªè¦åœ¨qhd_forwardInvocationè°ƒç”¨æ–°æ–¹æ³•å³å¯</span></span><br><span class="line">    SEL newSelecotr = qhd_createNewSelector(originSelector);</span><br><span class="line">    <span class="built_in">BOOL</span> isAdd = class_addMethod(cls, newSelecotr, originIMP, originTypes);</span><br><span class="line">    <span class="keyword">if</span> (!isAdd) &#123;</span><br><span class="line">        DEV_LOG(<span class="string">@"class_addMethod fail"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>é˜è¿°ä¸€ä¸‹å…·ä½“çš„è¿‡ç¨‹:</strong></p>
<ol>
<li><p>å¦‚ä½•è®©æ–¹æ³•æ¯æ¬¡éƒ½èµ°_objc_msgForwardå‘¢ï¼ŸæŠŠåŸæ¥çš„ selçš„IMPæ”¹æˆ_objc_msgForward.</p>
</li>
<li><p>è¿™æ—¶æˆ‘ä»¬éœ€è¦ä¿å­˜åŸæ¥çš„ IMP ç„¶åhook forwardInvocation â€¦ æ¢æˆè‡ªå·±çš„å®ç°ï¼Œè°ƒç”¨åŸæ¥çš„IMPå’Œæ–°å¢çš„ä»£ç </p>
</li>
</ol>
<p>ä»ä»£ç å¾ˆæ˜æ˜¾çš„å¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯åˆ©ç”¨OCçš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œé€‰æ‹©äº†åˆé€‚çš„æ—¶æœºï¼Œè¿›è¡Œæ‰“æ¡©ã€‚<br>ç›¸è¾ƒäºä¼ ç»Ÿçš„Swizzleæ–¹æ³•ï¼Œè¿™ç§æ–¹æ³•æ‰“ä¸»æ¡©ï¼Œæ˜¯æœ‰å¯è¡Œæ€§çš„ã€‚<br>å¹¶ä¸”åœ¨ForwardInvocation: å¤„ç†ï¼Œè™½ç„¶ç›¸è¾ƒå…¶ä½™ä¸¤ä¸ªè½¬å‘æœºåˆ¶è°ƒç”¨çš„æ–¹æ³•çš„æ¶ˆè€—å¤§ï¼Œä½†æ˜¯æ›´çµæ´»ä¸€äº›ï¼Œæœ€åˆ‡åˆé—®é¢˜ã€‚</p>
<h2 id="Aspects"><a href="#Aspects" class="headerlink" title="Aspects"></a>Aspects</h2><p>Aspects çš„ä»£ç æˆ‘çœ‹çš„æ¯”è¾ƒä»”ç»†ï¼Œç›¸å¯¹äºAnyMethodLog, Aspects å¯¹Hookçš„å¤„ç†æ›´æˆç†Ÿï¼Œå„ç§æƒ…å†µéƒ½åšäº†è€ƒè™‘ï¼Œè¿™é‡Œæ¥é‡ç‚¹åˆ†æä¸‹ã€‚</p>
<p>ç›¸è¾ƒäºAnyMethodLog, Aspects ä¸ä»…å¯ä»¥hookç±»ï¼Œä¹Ÿå¯ä»¥å¯¹å®ä¾‹è¿›è¡Œhook, ç²’åº¦æ›´å°ï¼Œé€‚ç”¨çš„åœºæ™¯æ›´åŠ å¤šæ ·åŒ–ã€‚</p>
<p>è¿™æ˜¯Aspects Hook çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å¯¹å®ä¾‹å’Œç±»çš„å¤„ç†æ˜¯ä¸åŒçš„ã€‚</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class aspect_hookClass(<span class="built_in">NSObject</span> *<span class="keyword">self</span>, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">	Class statedClass = <span class="keyword">self</span>.class;</span><br><span class="line">	Class baseClass = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">	<span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(baseClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Already subclassed</span></span><br><span class="line">	<span class="keyword">if</span> ([className hasSuffix:AspectsSubclassSuffix]) &#123;</span><br><span class="line">		<span class="keyword">return</span> baseClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We swizzle a class object, not a single object.</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (class_isMetaClass(baseClass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace((Class)<span class="keyword">self</span>);</span><br><span class="line">        <span class="comment">// Probably a KVO'ed class. Swizzle in place. Also swizzle meta classes in place.</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (statedClass != baseClass) &#123;</span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace(baseClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default case. Create dynamic subclass.</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *subclassName = [className stringByAppendingString:AspectsSubclassSuffix].UTF8String;</span><br><span class="line">	Class subclass = objc_getClass(subclassName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123;</span><br><span class="line">		subclass = objc_allocateClassPair(baseClass, subclassName, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *errrorDesc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"objc_allocateClassPair failed to allocate class %s."</span>, subclassName];</span><br><span class="line">            AspectError(AspectErrorFailedToAllocateClassPair, errrorDesc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		aspect_swizzleForwardInvocation(subclass);</span><br><span class="line">		aspect_hookedGetClass(subclass, statedClass);</span><br><span class="line">		aspect_hookedGetClass(object_getClass(subclass), statedClass);</span><br><span class="line">		objc_registerClassPair(subclass);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	object_setClass(<span class="keyword">self</span>, subclass);</span><br><span class="line">	<span class="keyword">return</span> subclass;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">å…ˆçœ‹çœ‹å¯¹å®ä¾‹çš„å¤„ç†</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```objectivec</span><br><span class="line">		subclass = objc_allocateClassPair(baseClass, subclassName, <span class="number">0</span>);</span><br><span class="line">		aspect_swizzleForwardInvocation(subclass);</span><br><span class="line">		aspect_hookedGetClass(subclass, statedClass);</span><br><span class="line">		aspect_hookedGetClass(object_getClass(subclass), statedClass);</span><br><span class="line">		objc_registerClassPair(subclass);</span><br><span class="line">	    object_setClass(<span class="keyword">self</span>, subclass);</span><br></pre></td></tr></table></figure>

<p>ç†Ÿæ‚‰kvoåŸç†çš„åŒå­¦ï¼Œä¸€çœ¼å°±åº”è¯¥çœ‹æ˜ç™½äº†ï¼Œè¿™æ˜¯åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚<br>è¿™é‡Œå¯è°“æ˜¯ç›¸å½“å·§å¦™çš„é¿å…äº†çˆ¶ç±»å’Œå­ç±»å®ä¾‹hookç›¸åŒçš„IMPå¯èƒ½å¯¼è‡´çš„å¾ªç¯è°ƒç”¨é—®é¢˜ã€‚(ä¸‹ä¸€éƒ¨åˆ†ä¼šè¯´æ˜å¦‚ä½•é¿å…çš„)</p>
<p>å¯¹ç±»çš„hookå’ŒAnyMethodLogååˆ†ç±»ä¼¼ã€‚å°±ä¸å†å¤šé˜è¿°äº†ã€‚ç½‘ä¸Šç›¸å…³ä»‹ç» ä½¿ç”¨ forwardInvocation+hookç±» çš„èµ„æ–™å¾ˆå¤šã€‚</p>
<p>Aspectså’ŒAnyMethodLogéƒ½æ˜¯åˆ©ç”¨äº†forwardInvocationè¿›è¡Œå¤„ç†ï¼Œè¿™æ˜¯ä¸€è‡´çš„ã€‚</p>
<h2 id="ç°è¡ŒHookæ–¹æ¡ˆçš„é—®é¢˜"><a href="#ç°è¡ŒHookæ–¹æ¡ˆçš„é—®é¢˜" class="headerlink" title="ç°è¡ŒHookæ–¹æ¡ˆçš„é—®é¢˜"></a>ç°è¡ŒHookæ–¹æ¡ˆçš„é—®é¢˜</h2><p>è‡ªå·±ç»å¸¸hookçš„åŒå­¦å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨hookæ—¶ï¼Œä¼šå‡ºç°è°ƒç”¨å¾ªç¯çš„é—®é¢˜ã€‚</p>
<p>æ— è®ºæ˜¯AnyMethodLog å’Œ Aspects éƒ½æ— æ³•åŒæ—¶hook çˆ¶ç±»å’Œå­ç±»çš„åŒä¸€ä¸ªæ–¹æ³•åˆ°ä¸€ä¸ªç›¸åŒçš„IMPä¸Šã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šå‡ºç°å¾ªç¯è°ƒç”¨ï¼Ÿ é‚£å¿…å®šæ˜¯ï¼Œè°ƒç”¨æ–¹åˆè¢«è°ƒç”¨è€…è°ƒç”¨äº†ä¸€æ¬¡ï¼Œåœ¨iOS Hook ä¸­ï¼Œå¦‚æœæˆ‘ä»¬hook äº† çˆ¶ç±»å’Œå­ç±»çš„åŒä¸€ä¸ªæ–¹æ³•ï¼Œè®©ä»–ä»¬æ‹¥æœ‰ç›¸åŒçš„å®ç°ï¼Œå°±ä¼šå‡ºç°è¿™ç§é—®é¢˜ã€‚</p>
<blockquote>
<p>çœ‹ä¸€ä¸‹é˜¿é‡ŒğŸŒŸçš„é˜è¿°ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯å¾ˆæ¸…æ™°çš„<br><a href="http://satanwoo.github.io/2017/09/24/mainthreadchecker1/" target="_blank" rel="noopener">åŸºäºæ¡¥çš„å…¨é‡æ–¹æ³•Hookæ–¹æ¡ˆ - æ¢ç©¶è‹¹æœä¸»çº¿ç¨‹æ£€æŸ¥å®ç°</a><br>å‡è®¾æˆ‘ä»¬ç°åœ¨å¯¹UIViewã€UIButtonéƒ½Hookäº†initWithFrame:è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è°ƒç”¨[[UIView alloc] initWithFrame:]å’Œ[[UIButton alloc] initWithFrame:]éƒ½ä¼šå®šå‘åˆ°Cå‡½æ•°qhd_forwardInvocationä¸­ï¼Œåœ¨UIViewè°ƒç”¨çš„æ—¶å€™æ²¡é—®é¢˜ã€‚ä½†æ˜¯åœ¨UIButtonè°ƒç”¨çš„æ—¶å€™ï¼Œç”±äºå…¶å†…éƒ¨å®ç°è·å–äº†super initWithFrame:ï¼Œå°±äº§ç”Ÿäº†å¾ªç¯å®šå‘çš„é—®é¢˜ã€‚ </p>
</blockquote>
<p>Aspects ä¸­ï¼ŒHook ä¹‹å‰ï¼Œæ˜¯è¦å¯¹èƒ½å¦hook è¿›è¡Œæ£€æŸ¥äº†ï¼Œå¯¹äºç±»ï¼Œæœ‰ä¸¥æ ¼çš„é™åˆ¶ï¼Œå¯¹äºå®ä¾‹åˆ™æ²¡æœ‰é™åˆ¶ã€‚</p>
<p>ç±»ä¸ºä»€ä¹ˆè¦é™åˆ¶ï¼Œä¸Šé¢å·²ç»é˜é‡Šäº†ï¼Œé‚£ä¹ˆå®ä¾‹ä¸ºä»€ä¹ˆå¯ä»¥å‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯ å®ä¾‹Hook å®ç°æ–¹å¼æ‰€äº§ç”Ÿçš„ç»“æœã€‚</p>
<p><strong>æ¥ç†ä¸€ä¸‹å®ä¾‹hookæ€ä¹ˆå®ç°çš„ï¼š</strong></p>
<ol>
<li>ç”Ÿæˆå­ç±»</li>
<li>hook å­ç±»çš„forwardInvocation(è¿™æ˜¯ä¸€ç³»åˆ—æ“ä½œï¼Œä¸è¿‡è¿™ä¸ªå°¤ä¸ºé‡è¦)</li>
<li>å¯¹å®ä¾‹çš„ç±»ä¿¡æ¯è¿›è¡Œä¼ªè£…</li>
</ol>
<p>å¦‚æœæˆ‘ä»¬æœ‰ ClassA çš„ å®ä¾‹ a, SubClassA çš„ å®ä¾‹ suba.<br>å¯¹ä»–ä»¬è¿›è¡Œhook <code>viewdidload</code> æ–¹æ³•, é‚£ä¹ˆä¼šç”Ÿæˆä¸¤ä¸ªå­ç±»ï¼Œæˆ‘ä»¬è®°ä¸ºprefix_ClassA, prefix_SubClassA,æˆ‘ä»¬å¯¹forwardInvocation IMPçš„æ›¿æ¢ï¼Œå®é™…ä¸Šæ˜¯åœ¨è¿™ä¸¤ä¸ªç±»ä¸Šè¿›è¡Œçš„ã€‚</p>
<p>å½“æ–¹æ³•è°ƒç”¨æ—¶:<br>suba -&gt; forwardInvocation(æˆ‘ä»¬æ›¿æ¢çš„IMP) -&gt;self viewdidload(SubClassA çš„IMP) -&gt; super viewdidload(ClassAçš„å®ç°)<br>è¿™æ˜¾ç„¶ä¸ä¼šå¯¼è‡´å¾ªç¯çš„é—®é¢˜ã€‚</p>
<p>å¦‚æœä¸é‡‡ç”¨å¯¹ç”Ÿæˆçš„å­ç±»hookï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œå¯ä»¥è¿‡ä¸€éæ–¹æ³•è°ƒç”¨çš„æµç¨‹ã€‚</p>
<p>æ€»ä¹‹ï¼Œè¿˜æ˜¯çˆ¶ç±»å­ç±»çš„ç›¸åŒæ–¹æ³•æ˜¯å¦æ˜¯åŒä¸€ä¸ªIMPçš„æ ¸å¿ƒé—®é¢˜ã€‚</p>
<p>éšåï¼ŒAspects åšäº† å¦‚æœæ˜¯çœŸæ­£çš„æ¶ˆæ¯è½¬å‘å“åº”çš„å¤„ç†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹ã€‚<br>JSPatch çš„æ–¹æ³•æ›¿æ¢ä¹Ÿæ˜¯åˆ©ç”¨äº† forwardInvocationè¿›è¡Œå¤„ç†ã€‚</p>
<h2 id="æ–¹æ³•æ··å†™å’ŒISAæ··å†™"><a href="#æ–¹æ³•æ··å†™å’ŒISAæ··å†™" class="headerlink" title="æ–¹æ³•æ··å†™å’ŒISAæ··å†™"></a>æ–¹æ³•æ··å†™å’ŒISAæ··å†™</h2><p>ä»Šå¤©æ— æ„åœ¨ feiox ç•™ç»™æˆ‘çš„ä¹¦ä¸Šå‘ç°äº†è¿™ä¸ªå®šä¹‰ã€‚<br>å†æŠŠ Aspects å’Œ AnyMethodLog çš„å®ç°ç›¸ç»“åˆï¼Œå‘ç°ä¹¦ä¸Šè¯´çš„çœŸçš„è´´åˆ‡ã€‚</p>
<ul>
<li><strong>æ–¹æ³•æ··å†™</strong><ul>
<li>å½±å“ä¸€ä¸ªç±»çš„æ‰€æœ‰å®ä¾‹</li>
<li>é«˜åº¦é€æ˜ï¼Œæ‰€æœ‰å¯¹è±¡çš„ç±»éƒ½ä¸å˜</li>
<li>éœ€è¦ç‰¹æ®Šçš„è¦†ç›–æ–¹æ³•å®ç°</li>
</ul>
</li>
<li><strong>ISAæ··å†™</strong><ul>
<li>åªå½±å“ç›®æ ‡å®ä¾‹</li>
<li>å¯¹è±¡çš„ç±»ä¼šå˜åŒ–(ä¸è¿‡å¯ä»¥é€šè¿‡è¦†ç›–classæ–¹æ³•éšè—)</li>
<li>è¦†ç›–æ–¹æ³•ä½¿ç”¨æ ‡å‡†çš„å­ç±»æŠ€æœ¯å®ç°çš„</li>
</ul>
</li>
</ul>
<h2 id="å®æˆ˜ä¸­çŠ¯è¿‡çš„é”™è¯¯"><a href="#å®æˆ˜ä¸­çŠ¯è¿‡çš„é”™è¯¯" class="headerlink" title="å®æˆ˜ä¸­çŠ¯è¿‡çš„é”™è¯¯"></a>å®æˆ˜ä¸­çŠ¯è¿‡çš„é”™è¯¯</h2><ol>
<li>çˆ¶å­ç±»  ä½¿ç”¨category  hook åŒä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”hookçš„æ–°æ–¹æ³•åè¿˜æ˜¯ä¸€æ ·çš„</li>
</ol>
<p>// TableViewSetDelegate call<br>// tableView.setdelegate -&gt; scrollView.setdelegate</p>
<p>// HOOK<br>// TableView.hmd_set -&gt; TABLEOriginSETIMP<br>// TableView.set -&gt; TABLEhmdSETIMP<br>// ScrollView.hmd_set -&gt; SCROLLoriginSETIMP<br>// ScrollView.set -&gt; SCROLLhmd_setIMP</p>
<p>// tableView.setdelegate -&gt; TABLEhmdSETIMP -&gt; TABLOEriginSETIMP -&gt; ScrollView.hmd_set -&gt; TABLEOriginSETIMP</p>
<p>// tableview category TABLEOriginSETIMP è¦†ç›–äº† UIScrollView category  hmd_set çš„å®ç°</p>
<p>// å¯¼è‡´ ScrollView.hmd_set å’Œ TableView.hmd_set æŒ‡å‘äº† åŒä¸€ä¸ª IMP</p>
<p><img src="callStack.png" alt="callstack"></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/30/ioshookanalysis/" data-id="ck3fztqfb000l9b36chrxgira" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
    
<ul id="article-nav" class="nav nav-pills nav-justified">
  
  <li role="presentation">
    <a href="/2017/10/27/dyld3withappstart/" id="article-nav-older" class="article-nav-link-wrap">
      <i class="fa fa-chevron-left pull-left"></i>
      <span class="article-nav-link-title">é“¾æ¥å’ŒAppå¯åŠ¨é€Ÿåº¦ä¼˜åŒ–</span>
    </a>
  </li>
  
  
  <li role="presentation">
    <a href="/2017/12/04/safeSwizzleRSSwizzleAnalyze/" id="article-nav-newer" class="article-nav-link-wrap">
      <span class="article-nav-link-title">Method Swizzling çš„æ­£ç¡®é€”å¾„</span>
      <i class="fa fa-chevron-right pull-right"></i>
    </a>
  </li>
  
</ul>


  
</article>




        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p>æ‰‹æ·˜æ¶æ„ç»„æ‹›äºº jimu.xjy@alibaba-inc.com</p>

</div>


  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/APM/">APM</a><span class="sidebar-module-list-count">6</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Hook/">Hook</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/iOS/">iOS</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">æºç åˆ†æ</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/%E7%A0%94%E5%8F%91%E6%B5%81%E7%A8%8B/">ç ”å‘æµç¨‹</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%9E%B6%E6%9E%84/">è®¾è®¡æ¶æ„</a><span class="sidebar-module-list-count">3</span></li></ul>
  </div>



  


  

  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/10/">October 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2019/09/">September 2019</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/09/">September 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/06/">June 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/05/">May 2018</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/04/">April 2018</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2018/01/">January 2018</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/12/">December 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/11/">November 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/10/">October 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/09/">September 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/05/">May 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/04/">April 2017</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/02/">February 2017</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/01/">January 2017</a><span class="sidebar-module-list-count">2</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2019/10/05/cocoapodsdev/">CocoaPodsæ’ä»¶å¼€å‘åŸç†(ä¸€) CocoaPodsåšäº†å•¥</a>
        </li>
      
        <li>
          <a href="/2019/09/28/CrashMonitorSystem/">å´©æºƒæ•è·ç³»ç»Ÿçš„åŸç†ï¼ˆä¸€ï¼‰å¼‚å¸¸ä¿¡å·</a>
        </li>
      
        <li>
          <a href="/2018/09/30/dwarf%E5%92%8C%E7%AC%A6%E5%8F%B7%E5%8C%96/">DWARFå’Œç¬¦å·åŒ–</a>
        </li>
      
        <li>
          <a href="/2018/09/16/CrashSymbolicateSystemDesign/">APM Crashç³»ç»Ÿ</a>
        </li>
      
        <li>
          <a href="/2018/06/13/libmalloc/">libmalloc &#34;malloc&#34; æ¢ç©¶</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2019 junyixie<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
